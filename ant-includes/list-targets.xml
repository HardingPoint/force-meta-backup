<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:sf="antlib:com.salesforce">

  <target name="-setUpLists" depends="-setUp">
    <property name="build.lists.dir" value="${build.dir}/lists" />
    <mkdir dir="${build.lists.dir}" />
  </target>

  <target name="describeMetadata" depends="-setUp">
    <sf:describeMetadata
      resultFilePath="${build.dir}/describe.log" 
      username="${sf.username}"
      password="${sf.password}"
      serverurl="${sf.serverurl}"
    />
  </target>

  <!-- Generate list* targets for listing specific metadata types -->

  <script language="javascript">
    <classpath>
      <fileset dir="lib" includes="*.jar" />
    </classpath>
    <![CDATA[
    importClass(org.apache.tools.ant.Target);
    importClass(com.salesforce.ant.ListMetadataTask);

    // TODO Get types dynamically
    var types = [
      'ActionOverride',
      'ActivitiesSettings',
      'AddressSettings',
      'AnalyticSnapshot',
      'ApexClass',
      'ApexComponent',
      'ApexPage',
      'ApexTrigger',
      'ApprovalProcess',
      'ArticleType',
      'AssignmentRules',
      'AuthProvider',
      'AutoResponseRules',
      'BaseSharingRule',
      'BusinessHoursSettings',
      'BusinessProcess',
      'CallCenter',
      'CaseSettings',
      'ChatterAnswersSettings',
      'Community',
      'CompactLayout',
      'CompanySettings',
      'ConnectedApp',
      'ContractSettings',
      'CriteriaBasedSharingRule',
      'CustomApplication',
      'CustomApplicationComponent',
      'CustomField',
      'CustomLabels',
      'CustomObject',
      'CustomObjectTranslation',
      'CustomPageWebLink',
      'CustomSite',
      'CustomTab',
      'Dashboard',
      'DataCategoryGroup',
      'Document',
      'EmailTemplate',
      'EntitlementProcess',
      'EntitlementSettings',
      'EntitlementTemplate',
      'ExternalDataSource',
      'FieldSet',
      'FlexiPage',
      'Flow',
      'Folder',
      'FolderShare',
      'ForecastingSettings',
      'Group',
      'HomePageComponent',
      'HomePageLayout',
      'IdeasSettings',
      'InstalledPackage',
      'KnowledgeSettings',
      'Layout',
      'Letterhead',
      'LiveAgentSettings',
      'LiveChatAgentConfig',
      'LiveChatButton',
      'LiveChatDeployment',
      'Metadata',
      'MetadataWithContent',
      'MilestoneType',
      'MobileSettings',
      'NamedFilter',
      'Network',
      'OpportunitySettings',
      'OwnerSharingRule',
      'Package',
      'PermissionSet',
      'Pick',
      'Portal',
      'PostTemplate',
      'ProductSettings',
      'Profile',
      'Queue',
      'QuickAction',
      'QuoteSettings',
      'RecordType',
      'RemoteSiteSetting',
      'Report',
      'ReportType',
      'Role',
      'SamlSsoConfig',
      'Scontrol',
      'SearchLayouts',
      'SecuritySettings',
      'SharingReason',
      'SharingRecalculation',
      'SharingRules',
      'Skill',
      'StaticResource',
      'SynonymDictionary',
      'Territory',
      'Translations',
      'ValidationRule',
      'View',
      'Weblink',
      'Workflow'
    ];

    var allTarget = new Target();
    allTarget.setProject(project);
    allTarget.setName('list_All');
    project.addTarget(allTarget);

    for (var i = 0; i < types.length; i++) {
      var type = types[i];
      var targetName = 'list' + type;
      var target = new Target();
      var task = project.createTask('antlib:com.salesforce:listMetadata');

      task.setMetadataType(type);
      task.setResultFilePath(project.getProperty('build.lists.dir') + '/' + type + '.log');
      task.setUsername(project.getProperty('sf.username'));
      task.setPassword(project.getProperty('sf.password'));
      task.setServerURL(project.getProperty('sf.serverurl'));

      target.setName(targetName);
      target.setProject(project);
      target.setDescription('List metadata for ' + type);
      target.addDependency('-setUpLists');
      target.addTask(task);
      
      allTarget.addDependency(targetName);

      project.addTarget(target);
    }

  ]]></script>

  <target name="test" depends="-setUpLists">
    <sf:listMetadata metadataType="CustomObject"
      resultFilePath="${build.lists.dir}/CustomObject.log"
      username="${sf.username}"
      password="${sf.password}"
      serverurl="${sf.serverurl}" />
    </target>
  <target name="test2" depends="-setUpLists"><antcall target="-sfListMetadata"><param name="metadataType" value="CustomObject" /></antcall></target>
</project>
